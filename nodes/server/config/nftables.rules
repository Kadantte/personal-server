#!/sbin/nft -f

flush ruleset

table inet SERVER_FIREWALL {

        set denylist {
              type ipv4_addr; flags dynamic, timeout; timeout 5m;
        }

        chain input {
              type filter hook input priority 0; policy drop;

              ct state invalid drop comment "early drop of invalid packets"
              ct state {established, related} accept comment "accept all connections related to connections made by us"

              iif lo accept comment "accept loopback"
              iifname wg0 accept comment "accept wireguard traffic"
              iifname cni0 accept comment "accept kube traffic"
              iifname flannel.1 accept comment "accept kube traffic"

              meta l4proto icmp accept comment "Accept ICMP"
              meta l4proto ipv6-icmp accept comment "accept all ICMP types"
              udp dport 546 ip6 saddr { fc00::/7, fe80::/10, 2001:bc8:2::5:136:1 } accept comment "allow DHCPv6 client"



              tcp dport 22 accept comment "accept local SSH"

              tcp dport { 80, 443 } accept comment "accept http"

              tcp dport { 25, 465 } accept comment "accept smtp"
              tcp dport 993 accept comment "accept imaps"

              udp dport 995 accept comment "accept wireguard"

              #tcp dport 6443 accept comment "accept kubernetes"
        }

        chain nat_pretrouting {
              type nat hook prerouting priority 0; policy accept;

              tcp dport {22, 25, 465, 2222} ct state new, untracked limit rate over 5/minute add @denylist { ip saddr } comment "add to blacklist"
              ip saddr @denylist drop comment "dont allow blacklisted ip"

              iif enp1s0 tcp dport 2222 dnat ip to 10.200.0.6:2222 comment "forward to warpgate ssh connections"
              iif enp1s0 tcp dport 2222 dnat ip6 to [fd00:cafe::6]:2222 comment "forward to warpgate ssh connections"
        }

        chain forward {
              type filter hook forward priority 0; policy drop;

              iifname cni0 accept comment "Allow outgoing forward of kube traffic"
              oifname cni0 accept comment "Allow incoming forward of kube traffic"

              iifname wg0 accept comment "accept wireguard traffic"
              oifname wg0 accept comment "accept wireguard traffic"
        }

        chain nat_postrouting {
              type nat hook postrouting priority 0; policy accept;

              iif enp1s0 tcp dport 2222 ip daddr 10.200.0.6 masquerade comment "forward to warpgate ssh connections"
              iif enp1s0 tcp dport 2222 ip6 daddr fd00:cafe::6 masquerade comment "forward to warpgate ssh connections"

              oif enp1s0 ip saddr 10.42.0.0/24 masquerade comment "NAT kube traffic to avoid leaking private network"

              oif enp1s0 ip saddr 10.200.0.0/24 masquerade comment "Allow NATing IPv4 wireguard traffic"
              oif enp1s0 ip6 saddr fd00:cafe::/32 masquerade comment "Allow NATing IPv6 wireguard traffic"
        }

        chain output {
              type filter hook output priority 0; policy accept;
        }
}
